<!DOCTYPE html>
<html lang="en">
  <head>
    <link href="/static/mermaid.min.css" rel="stylesheet"/>
    <style>
     a.notvisible:link, a.notvisible:visited {
         color: gray;
         background-color: transparent;
         text-decoration: none;
     }
    </style>
  </head>
  <body>
    <input type="checkbox" id="visible" onclick="filter()"/>
    <label for="visible">Visible</label>
    <input type="checkbox" id="messier" onclick="filter()"/>
    <label for="messier">Messier</label>
    <input type="checkbox" id="named" onclick="filter()"/>
    <label for="named">Named</label>

    <div id="wrapper"></div>
    <script src="/static/grid.umd.js"></script>
    <script>
     const m = document.getElementById("messier");
     const n = document.getElementById("named");
     const v = document.getElementById("visible");

     document.addEventListener('DOMContentLoaded', () => {
         const urlParams = new URLSearchParams(window.location.search);
         m.checked = urlParams.get('messier') == "true";
         n.checked = urlParams.get('named') == "true";
         v.checked = urlParams.get('visible') == "true";
     });

     function filter() {
         addQuery('messier', m.checked.toString());
         addQuery('visible', v.checked.toString());
         addQuery('named', n.checked.toString());

         grid.forceRender();
     }

     function filters() {
         return {
             'messier': m.checked.toString(),
             'visible': v.checked.toString(),
             'named': n.checked.toString()
         }
     }

     function addQuery(key, value) {
         const url = new URL(window.location.href);
         url.searchParams.set(key, value);
         window.history.replaceState({}, '', url);
     }

     const grid = new gridjs.Grid({
         search: true,
         pagination: {
             limit: 15,
             server: {
                 url: (prev, page, limit) => {
                     const url = new URL(prev, document.location);
                     url.searchParams.append('page', page);
                     url.searchParams.append('pagesize', limit);
                     Object.entries(filters()).forEach(([key, value]) => {
                         url.searchParams.append(key, value);
                     });
                     console.log(url.href);
                     return url.href;
                 }
             }
         },
         search: {
             server: {
                 url: (prev, keyword) => {
                     const url = new URL(prev, document.location);
                     url.searchParams.append('name', keyword);
                     return url.href;
                 }
             }
         },
         server: {
             url: '/objects',
             then: data => data.objects.map(obj => {
                 var style = 'visible';
                 var id = obj.id;

                 if (!obj.visible) {
                     style = 'notvisible';
                 }
                 if (obj.m) {
                     id = `${id} (M${obj.m})`;
                 }

                 return [
                     gridjs.html(`<a class='${style}' href='/${obj.id}'>${id}</a>`),
                     obj.hour_angle,
                     obj.dec,
                     obj.type,
                     obj.name
             ]}),
             total: data => data.total
         },
         columns: [
             {
                 name: "id",
                 width: "180px"
             },
             {
                 name: "hour angle",
                 width: "100px"
             },
             {
                 name: "dec",
                 width: "100px"
             },
             {
                 name: "type",
                 width: "100px",
                 filter: true
             },
             {
                 name: "name"
             },
         ],
         sort: true
     }).render(document.getElementById("wrapper"));
    </script>
  </body>
</html>

