<!DOCTYPE html>
<html lang="en">
  <head>
    <link href="/static/mermaid.min.css" rel="stylesheet"/>
    <style>
     a.notvisible:link, a.notvisible:visited {
         color: gray;
         background-color: transparent;
         text-decoration: none;
     }
    </style>
  </head>
  <body>
    <input type="checkbox" id="visible" onclick="filter()"/>
    <label for="visible">Visible</label>
    <input type="checkbox" id="messier" onclick="filter()"/>
    <label for="messier">Messier</label>
    <input type="checkbox" id="named" onclick="filter()"/>
    <label for="named">Named</label>
    <input type="checkbox" id="nebula" onclick="filter()"/>
    <label for="nebula">Nebula</label>
    <input type="checkbox" id="nova" onclick="filter()"/>
    <label for="nova">Nova</label>
    <input type="checkbox" id="galaxy" onclick="filter()"/>
    <label for="galaxy">Galaxy</label>
    <input type="checkbox" id="galaxy_group" onclick="filter()"/>
    <label for="galaxy_group">Galaxy Group</label>
    <input type="checkbox" id="galaxy_triple" onclick="filter()"/>
    <label for="galaxy_triple">Galaxy Triple</label>
    <input type="checkbox" id="galaxy_pair" onclick="filter()"/>
    <label for="galaxy_pair">Galaxy Pair</label>
    <input type="checkbox" id="double_star" onclick="filter()"/>
    <label for="double_star">Double Star</label>

    <div id="table"></div>

    <script src="/static/grid.umd.js"></script>
    <script>
     const filters = [
         {em: document.getElementById("messier"), param: "messier", f: function(checked) {return checked.toString()}},
         {em: document.getElementById("named"), param: "named", f: function(checked) {return checked.toString()}},
         {em: document.getElementById("visible"), param: "visible", f: function(checked) {return checked.toString()}},
         {em: document.getElementById("nova"), param: "type", f: function(checked) {return checked ? "Nova": "false"}},
         {em: document.getElementById("galaxy"), param: "type", f: function(checked) {return checked ? "G": "false"}},
         {em: document.getElementById("galaxy_group"), param: "type", f: function(checked) {return checked ? "GGroup": "false"}},
         {em: document.getElementById("galaxy_triple"), param: "type", f: function(checked) {return checked ? "GTrpl": "false"}},
         {em: document.getElementById("galaxy_pair"), param: "type", f: function(checked) {return checked ? "GPair": "false"}},
         {em: document.getElementById("nebula"), param: "type", f: function(checked) {return checked ? "Neb": "false"}},
         {em: document.getElementById("double_star"), param: "type", f: function(checked) {return checked ? "**": "false"}}
     ];

     document.addEventListener('DOMContentLoaded', () => {
         const urlParams = new URLSearchParams(window.location.search);
         filters.forEach((val) => {
             if (val.param == "type") {
                 val.em.checked = urlParams.getAll(val.param).includes(val.f(true));
             } else {
                 val.em.checked = urlParams.get(val.param) == val.f(val.em.checked);
             }
         });
     });

     function filter() {
         const url = new URL(window.location.href);
         url.search = '';
         filters.forEach((val) => {
             addQuery(url, val.param, val.f(val.em.checked), val.f(true));
         });
         window.history.replaceState({}, '', url);
         grid.forceRender();
     }

     function addQuery(url, key, state, value) {
         if (state == "true") {
             url.searchParams.set(key, value);
         } else if (key == "type" && state == value) {
             url.searchParams.append(key, value);
         }
     }

     const grid = new gridjs.Grid({
         search: true,
         pagination: {
             limit: 15,
             server: {
                 url: (prev, page, limit) => {
                     const url = new URL(prev, document.location);
                     url.searchParams.append('page', page);
                     url.searchParams.append('pagesize', limit);
                     filters.forEach((val) => {
                         addQuery(url, val.param, val.f(val.em.checked), val.f(true));
                     });
                     return url.href;
                 }
             }
         },
         search: {
             server: {
                 url: (prev, keyword) => {
                     const url = new URL(prev, document.location);
                     url.searchParams.append('name', keyword);
                     return url.href;
                 }
             }
         },
         server: {
             url: '/objects',
             then: data => data.objects.map(obj => {
                 var style = 'visible';
                 var id = obj.id;

                 if (!obj.visible) {
                     style = 'notvisible';
                 }
                 if (obj.m) {
                     id = `${id} (M${obj.m})`;
                 }

                 return [
                     gridjs.html(`<a class='${style}' href='/${obj.id}'>${id}</a>`),
                     obj.magnitude,
                     obj.hour_angle,
                     obj.dec,
                     obj.type,
                     obj.name
             ]}),
             total: data => data.total
         },
         columns: [
             {
                 name: "id",
                 width: "150px"
             },
             {
                 name: "mag.",
                 width: "70px"
             },
             {
                 name: "âˆ ",
                 width: "60px"
             },
             {
                 name: "dec",
                 width: "100px"
             },
             {
                 name: "type",
                 width: "60px"
             },
             {
                 name: "name"
             },
         ],
         sort: false
     }).render(document.getElementById("table"));
    </script>
  </body>
</html>

